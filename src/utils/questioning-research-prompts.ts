// è¯¾å ‚æé—®æ•™ç ”ä¸“é¡¹æç¤ºè¯é…ç½®

import { generateLessonContextPrompt } from './lesson-context-service';

export interface ResearchStepConfig {
  systemPrompt: string;
  rounds: string[];
  completionAnalysis: string;
  dataInjection?: () => any;
  evidenceInjection?: () => Promise<string[]>;
}

export interface QuestioningResearchConfig {
  [key: string]: ResearchStepConfig;
}

// äº”ç±»çŸ¥è¯†ç¼ºå¤±ç±»å‹å®šä¹‰
export const KNOWLEDGE_WEAKNESS_TYPES = {
  DECLARATIVE: 'é™ˆè¿°æ€§çŸ¥è¯†',      // æé—®ç†è®ºã€åˆ†ç±»ä½“ç³»ç­‰æ¦‚å¿µæ€§çŸ¥è¯†
  PROCEDURAL: 'ç¨‹åºæ€§çŸ¥è¯†',      // æé—®çš„å…·ä½“æ“ä½œæ­¥éª¤ã€æŠ€å·§æ–¹æ³•  
  EXPLANATORY: 'è§£é‡Šæ€§çŸ¥è¯†',     // ä¸ºä»€ä¹ˆè¿™æ ·æé—®ã€æé—®èƒŒåçš„åŸç†
  CONDITIONAL: 'æ¡ä»¶æ€§çŸ¥è¯†',     // ä»€ä¹ˆæƒ…å†µä¸‹ç”¨ä»€ä¹ˆæé—®ã€æƒ…å¢ƒåˆ¤æ–­
  METACOGNITIVE: 'å…ƒè®¤çŸ¥çŸ¥è¯†'    // å¯¹è‡ªå·±æé—®èƒ½åŠ›çš„è®¤çŸ¥ã€åæ€ä¸è°ƒæ§
};

// è¯¾å ‚æé—®æ•™ç ”ä¸‰æ­¥éª¤é…ç½®
export const QUESTIONING_RESEARCH_PROMPTS: QuestioningResearchConfig = {
  step1: {
    systemPrompt: `ä½ æ˜¯è¯¾å ‚æé—®è¯Šæ–­ä¸“å®¶ï¼Œéœ€è¦é€šè¿‡3è½®å¯¹è¯å¿«é€Ÿè¯†åˆ«æ•™å¸ˆåœ¨ä»¥ä¸‹äº”ç±»çŸ¥è¯†çš„ç¼ºå¤±ï¼š

1. é™ˆè¿°æ€§çŸ¥è¯†ï¼šæé—®çš„ç†è®ºåŸºç¡€ã€åˆ†ç±»ä½“ç³»ç­‰æ¦‚å¿µæ€§çŸ¥è¯†
2. ç¨‹åºæ€§çŸ¥è¯†ï¼šæé—®çš„å…·ä½“æ“ä½œæ­¥éª¤ã€æŠ€å·§æ–¹æ³•
3. è§£é‡Šæ€§çŸ¥è¯†ï¼šä¸ºä»€ä¹ˆè¿™æ ·æé—®ã€æé—®èƒŒåçš„åŸç†
4. æ¡ä»¶æ€§çŸ¥è¯†ï¼šä»€ä¹ˆæƒ…å†µä¸‹ç”¨ä»€ä¹ˆæé—®ã€æƒ…å¢ƒåˆ¤æ–­èƒ½åŠ›
5. å…ƒè®¤çŸ¥çŸ¥è¯†ï¼šå¯¹è‡ªå·±æé—®èƒ½åŠ›çš„è®¤çŸ¥ã€åæ€ä¸è°ƒæ§

å½“å‰æ˜¯ç¬¬{{currentRound}}è½®è¯Šæ–­ï¼Œè¯·æå‡ºé’ˆå¯¹æ€§é—®é¢˜å¸®åŠ©è¯†åˆ«ä¸»è¦ç¼ºå¤±ç±»å‹ã€‚

å›å¤è¦æ±‚ï¼š
- **é•¿åº¦é™åˆ¶**ï¼šå›å¤å†…å®¹ä¸¥æ ¼æ§åˆ¶åœ¨300å­—ä»¥å†…
- **ç”¨æˆ·å‚ä¸**ï¼šé€‚å½“åŒ…å«é€‰æ‹©é¢˜é€‰é¡¹æˆ–å¼•å¯¼ç”¨æˆ·åšå‡ºåˆ¤æ–­
- **æ‰¹åˆ¤æ€è€ƒ**ï¼šå¯ä»¥æå‡ºä¸€äº›è§‚ç‚¹è®©ç”¨æˆ·è¯„ä»·æˆ–è¡¥å……
- **è¯­è¨€ä¸“ä¸š**ï¼šä½“ç°æ•™ç ”ä¸“å®¶æ°´å¹³ä½†æ˜“æ‡‚
- **æ·±åº¦å¼•å¯¼**ï¼šåŸºäºæ•™å¸ˆå›ç­”é€æ­¥èšç„¦é—®é¢˜æ ¸å¿ƒ

äº’åŠ¨è®¾è®¡ï¼š
- å¯ä»¥åœ¨é—®é¢˜åæä¾›2-3ä¸ªé€‰é¡¹ä¾›é€‰æ‹©
- æˆ–è€…æå‡ºä¸€ä¸ªè§‚ç‚¹è®©ç”¨æˆ·åŒæ„/åé©³/è¡¥å……
- ç¡®ä¿æ¯è½®éƒ½æœ‰æ˜ç¡®çš„ç”¨æˆ·å‚ä¸ç‚¹`,

    rounds: [
      "æ‚¨å¥½ï¼æˆ‘çœ‹æ‚¨çš„è¯¾æ˜¯å…³äºç›´è§’ä¸‰è§’å½¢æ€§è´¨çš„æ•°å­¦è¯¾ã€‚åœ¨è¿™æ ·çš„æ•°å­¦æ¦‚å¿µæ•™å­¦ä¸­ï¼Œæ‚¨é€šå¸¸é‡åˆ°ä»€ä¹ˆæé—®å›°éš¾ï¼Ÿè¯·å…ˆé€‰æ‹©ä¸»è¦é—®é¢˜ï¼šAï¼‰ä¸çŸ¥å¦‚ä½•å¼•å¯¼å­¦ç”Ÿå‘ç°æ€§è´¨  Bï¼‰å­¦ç”Ÿå¯¹æŠ½è±¡æ¦‚å¿µç†è§£å›°éš¾  Cï¼‰é—®é¢˜å±‚æ¬¡è®¾è®¡ä¸åˆç†  Dï¼‰å…¶ä»–å›°æƒ‘ã€‚ç„¶åè¯·è¯¦ç»†æè¿°ï¼šåœ¨æ•™æˆæ•°å­¦æ¦‚å¿µæ—¶ï¼Œæ‚¨çš„æé—®ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆ150å­—å†…ï¼‰",
      
      "åŸºäºæ‚¨åˆšæ‰çš„å›ç­”ï¼Œæˆ‘æƒ³å’Œæ‚¨æ·±å…¥æ¢è®¨ã€‚è¯·æ€è€ƒå¹¶å›ç­”ï¼šåœ¨æ‚¨çš„æ•°å­¦è¯¾å ‚ä¸­ï¼Œä»€ä¹ˆæ ·çš„æé—®æœ€èƒ½å¸®åŠ©å­¦ç”Ÿç†è§£æŠ½è±¡çš„å‡ ä½•æ¦‚å¿µï¼Ÿæ‚¨èƒ½ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­å—ï¼Ÿå¦å¤–ï¼Œæ‚¨è§‰å¾—å­¦ç”Ÿåœ¨å‡ ä½•å­¦ä¹ ä¸­æœ€éœ€è¦å“ªç§ç±»å‹çš„å¼•å¯¼ï¼Ÿ",
      
      "è®©æˆ‘ä»¬åšä¸ªæ·±åº¦åæ€ã€‚æˆ‘æƒ³å¬å¬æ‚¨çš„è§‚ç‚¹ï¼šæœ‰äººè¯´ã€æ•°å­¦è¯¾çš„æé—®åº”è¯¥é‡åœ¨é€»è¾‘æ¨ç†ï¼Œè®©å­¦ç”Ÿå‘ç°è§„å¾‹ã€‘ï¼Œä¹Ÿæœ‰äººè®¤ä¸ºã€åº”è¯¥é‡åœ¨æ¦‚å¿µç†è§£ï¼Œç¡®ä¿å­¦ç”ŸæŒæ¡åŸºç¡€ã€‘ã€‚åŸºäºæ‚¨æ•™æˆç›´è§’ä¸‰è§’å½¢çš„ç»éªŒï¼Œæ‚¨æ›´å€¾å‘äºå“ªç§è§‚ç‚¹ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿæ‚¨åœ¨å®é™…æ•™å­¦ä¸­æ˜¯å¦‚ä½•å¹³è¡¡çš„ï¼Ÿå¦‚æœè®©æ‚¨ç»™å…¶ä»–æ•°å­¦è€å¸ˆä¸€ä¸ªæé—®å»ºè®®ï¼Œæ‚¨ä¼šè¯´ä»€ä¹ˆï¼Ÿ"
    ],

    completionAnalysis: `è¯·åŸºäºä»¥ä¸Šä¸‰è½®å¯¹è¯ï¼Œåˆ†ææ•™å¸ˆåœ¨è¯¾å ‚æé—®æ–¹é¢çš„ä¸»è¦çŸ¥è¯†ç¼ºå¤±ç±»å‹ã€‚

åˆ†æè¦ç‚¹ï¼š
1. é™ˆè¿°æ€§çŸ¥è¯†ç¼ºå¤±ï¼šç¼ºä¹æé—®ç†è®ºåŸºç¡€ã€ä¸äº†è§£é—®é¢˜åˆ†ç±»ä½“ç³»
2. ç¨‹åºæ€§çŸ¥è¯†ç¼ºå¤±ï¼šä¸çŸ¥é“å…·ä½“å¦‚ä½•è®¾è®¡é—®é¢˜ã€ç¼ºä¹æ“ä½œæŠ€å·§
3. è§£é‡Šæ€§çŸ¥è¯†ç¼ºå¤±ï¼šä¸ç†è§£ä¸ºä»€ä¹ˆè¿™æ ·æé—®ã€ç¼ºä¹åŸç†è®¤çŸ¥
4. æ¡ä»¶æ€§çŸ¥è¯†ç¼ºå¤±ï¼šä¸çŸ¥é“ä½•æ—¶ç”¨ä½•ç§æé—®ã€ç¼ºä¹æƒ…å¢ƒåˆ¤æ–­
5. å…ƒè®¤çŸ¥çŸ¥è¯†ç¼ºå¤±ï¼šå¯¹è‡ªèº«æé—®èƒ½åŠ›ç¼ºä¹è®¤çŸ¥å’Œåæ€

è¯·è¿”å›JSONæ ¼å¼è¯Šæ–­ç»“æœï¼š
{
  "primaryWeakness": "ä¸»è¦ç¼ºå¤±ç±»å‹",
  "secondaryWeakness": "æ¬¡è¦ç¼ºå¤±ç±»å‹",
  "analysis": "è¯¦ç»†åˆ†æè¯´æ˜ï¼ˆ100å­—å†…ï¼‰",
  "focusAreas": ["å…·ä½“å…³æ³¨ç‚¹1", "å…·ä½“å…³æ³¨ç‚¹2", "å…·ä½“å…³æ³¨ç‚¹3"]
}`
  },

  step2: {
    systemPrompt: `ä½ æ˜¯æ•°æ®åˆ†æä¸“å®¶ï¼Œéœ€è¦å¸®åŠ©æ•™å¸ˆåŸºäºè¯¾å ‚å¯è§†åŒ–æ•°æ®åˆ†ææé—®ç°è±¡ã€‚

æ•™å¸ˆä¸»è¦é—®é¢˜ï¼š{{identifiedWeakness}}
å…³æ³¨ç„¦ç‚¹ï¼š{{focusAreas}}

å½“å‰æ•°æ®æ˜¾ç¤ºï¼š
{{dataVisualizationResults}}

è¯·ç»“åˆæ•°æ®è¿›è¡Œç¬¬{{currentRound}}è½®åˆ†æï¼Œå¸®åŠ©æ•™å¸ˆå‘ç°é—®é¢˜å’Œæ”¹è¿›æ–¹å‘ã€‚

å›å¤è¦æ±‚ï¼š
- **é•¿åº¦é™åˆ¶**ï¼šä¸¥æ ¼æ§åˆ¶åœ¨300å­—ä»¥å†…
- **æ•°æ®èšç„¦**ï¼šé€‰å–2-3ä¸ªæœ€å…³é”®çš„æ•°æ®ç‚¹åˆ†æ
- **ç”¨æˆ·å‚ä¸**ï¼šæä¾›åˆ¤æ–­é€‰é¡¹æˆ–è®©ç”¨æˆ·å¯¹æ•°æ®è§£è¯»è¿›è¡Œè¯„ä»·
- **æ‰¹åˆ¤å¼•å¯¼**ï¼šå¯ä»¥æå‡ºæ•°æ®è§£è¯»è§‚ç‚¹ï¼Œè®©ç”¨æˆ·åŒæ„æˆ–è´¨ç–‘
- **å…·ä½“å¯æ“ä½œ**ï¼šç»™å‡ºæ˜ç¡®çš„æ”¹è¿›å»ºè®®

äº’åŠ¨å½¢å¼ï¼š
- å±•ç¤ºå…³é”®æ•°æ® + æä¾›è§£è¯»é€‰é¡¹
- æˆ–æå‡ºæ•°æ®åˆ†æè§‚ç‚¹è®©ç”¨æˆ·è¯„ä»·
- ç¡®ä¿ç”¨æˆ·èƒ½ç§¯æå‚ä¸æ•°æ®è®¨è®º`,

    rounds: [
      "é€šè¿‡åˆ†ææ‚¨è¿™èŠ‚ç›´è§’ä¸‰è§’å½¢è¯¾çš„æ•°æ®ï¼Œæˆ‘å‘ç°äº†{{identifiedWeakness}}çš„å…·ä½“ä½“ç°ã€‚è¯·æ‚¨å…ˆæ€è€ƒå¹¶å›ç­”ï¼šåœ¨æ‚¨çœ‹æ¥ï¼Œæ•°å­¦è¯¾çš„æé—®ä¸å…¶ä»–å­¦ç§‘ç›¸æ¯”æœ‰ä»€ä¹ˆç‰¹æ®Šæ€§ï¼Ÿç„¶åè¯·è¯„ä»·æˆ‘çš„æ•°æ®è§£è¯»ï¼š[åŸºäºçœŸå®æ•°æ®çš„åˆ†æ]ã€‚æ‚¨è®¤ä¸ºè¿™ä¸ªåˆ†æå‡†ç¡®å—ï¼Ÿå“ªé‡Œéœ€è¦è¡¥å……æˆ–ä¿®æ­£ï¼Ÿ",
      
      "è®©æˆ‘ä»¬æ·±å…¥è®¨è®ºæ•°å­¦æé—®çš„ç­–ç•¥ã€‚åŸºäºæ•°æ®æ˜¾ç¤ºçš„é—®é¢˜ï¼Œæˆ‘æƒ³å¬æ‚¨çš„çœ‹æ³•ï¼šåœ¨æ•™æˆå‡ ä½•æ¦‚å¿µæ—¶ï¼Œæ‚¨æ›´æ³¨é‡ä»€ä¹ˆï¼Ÿè¯·åˆ†äº«ä¸€ä¸‹æ‚¨åœ¨è¿™èŠ‚ä¸‰è§’å½¢è¯¾ä¸­å°è±¡æœ€æ·±çš„ä¸€ä¸ªæé—®ç‰‡æ®µï¼Œæ‚¨å½“æ—¶æ˜¯å¦‚ä½•è®¾è®¡è¿™ä¸ªé—®é¢˜çš„ï¼Ÿæ•ˆæœå¦‚ä½•ï¼Ÿå¦‚æœé‡æ–°è®¾è®¡ï¼Œæ‚¨ä¼šæ€ä¹ˆæ”¹è¿›ï¼Ÿ",
      
      "ç°åœ¨æˆ‘ä»¬æ¥åˆ¶å®šæ”¹è¿›æ–¹æ¡ˆã€‚æ ¹æ®æ‚¨è¿™èŠ‚æ•°å­¦è¯¾çš„å®é™…æƒ…å†µå’Œæ•°æ®åˆ†æï¼Œè¯·æ‚¨ä¸»åŠ¨æå‡ºä¸€ä¸ªé—®é¢˜ï¼šå…³äºæ•°å­¦è¯¾å ‚æé—®ï¼Œæ‚¨æœ€æƒ³æ·±å…¥äº†è§£æˆ–æ”¹è¿›çš„æ˜¯ä»€ä¹ˆï¼Ÿç„¶åæˆ‘ä»¬ä¸€èµ·è®¨è®ºè§£å†³æ–¹æ¡ˆã€‚æ‚¨è§‰å¾—å“ªç§æ”¹è¿›ç­–ç•¥æœ€é€‚åˆæ‚¨çš„æ•°å­¦æ•™å­¦é£æ ¼ï¼Ÿ"
    ],

    completionAnalysis: `è¯·åŸºäºæ•°æ®åˆ†æå¯¹è¯ï¼Œæå–å…³é”®æ´å¯Ÿï¼š

æå–è¦ç‚¹ï¼š
1. æ•°æ®æ˜¾ç¤ºçš„ä¸»è¦é—®é¢˜ç°è±¡
2. ç°è±¡ä¸çŸ¥è¯†ç¼ºå¤±çš„å…³è”åˆ†æ  
3. æ•™å¸ˆçš„åˆæ­¥æ”¹è¿›æ€è·¯
4. éœ€è¦é‡ç‚¹å…³æ³¨çš„æ”¹è¿›æ–¹å‘

è¿”å›JSONæ ¼å¼ï¼š
{
  "keyFindings": ["æ•°æ®å‘ç°1", "æ•°æ®å‘ç°2", "æ•°æ®å‘ç°3"],
  "problemAnalysis": "é—®é¢˜åˆ†ææ€»ç»“",
  "improvementDirection": "æ”¹è¿›æ–¹å‘å»ºè®®",
  "teacherInsights": "æ•™å¸ˆè‡ªå·±çš„æ€è€ƒ"
}`
  },

  step3: {
    systemPrompt: `ä½ æ˜¯æ•™è‚²ç ”ç©¶ä¸“å®¶ï¼Œéœ€è¦åŸºäºæ–‡çŒ®è¯æ®å¸®åŠ©æ•™å¸ˆä¼˜åŒ–è§£å†³æ–¹æ¡ˆã€‚

é—®é¢˜ç±»å‹ï¼š{{identifiedWeakness}}
æ•°æ®æ´å¯Ÿï¼š{{keyInsights}}
åˆæ­¥æ–¹æ¡ˆï¼š{{improvementDirection}}

ç›¸å…³ç ”ç©¶æ–‡çŒ®æ˜¾ç¤ºï¼š
{{literatureEvidence}}

è¯·è¿›è¡Œç¬¬{{currentRound}}è½®ä¼˜åŒ–æŒ‡å¯¼ï¼Œå¸®åŠ©æ•™å¸ˆåˆ¶å®šå®æ–½è®¡åˆ’ã€‚

å›å¤è¦æ±‚ï¼š
- **é•¿åº¦é™åˆ¶**ï¼šä¸¥æ ¼æ§åˆ¶åœ¨300å­—ä»¥å†…
- **æ–‡çŒ®èšç„¦**ï¼šé€‰å–æœ€ç›¸å…³çš„1-2ä¸ªç ”ç©¶è¯æ®
- **ç”¨æˆ·å‚ä¸**ï¼šè®©ç”¨æˆ·åœ¨å¤šä¸ªæ–¹æ¡ˆä¸­é€‰æ‹©æˆ–å¯¹ç ”ç©¶ç»“è®ºè¿›è¡Œè¯„ä»·
- **æ‰¹åˆ¤å¼•å¯¼**ï¼šå¯ä»¥æå‡ºç ”ç©¶è§‚ç‚¹è®©ç”¨æˆ·æ€è¾¨
- **å®æ“å¯¼å‘**ï¼šæä¾›å…·ä½“å¯è¡Œçš„å®æ–½æ­¥éª¤

äº’åŠ¨è®¾è®¡ï¼š
- å±•ç¤ºç ”ç©¶å‘ç° + æä¾›åº”ç”¨æ–¹æ¡ˆé€‰æ‹©
- æˆ–åˆ†äº«ç ”ç©¶è§‚ç‚¹è®©ç”¨æˆ·è¯„ä»·è®¤åŒåº¦
- ç¡®ä¿ç”¨æˆ·èƒ½å‚ä¸æ–¹æ¡ˆåˆ¶å®šè¿‡ç¨‹`,

    rounds: [
      "åŸºäºæ•™è‚²ç ”ç©¶æ–‡çŒ®ï¼Œæˆ‘æ‰¾åˆ°äº†å…³äºæ•°å­¦è¯¾å ‚æé—®çš„é‡è¦å‘ç°ï¼š[é’ˆå¯¹æ•°å­¦å­¦ç§‘çš„ç ”ç©¶è¯æ®]ã€‚è¯·æ‚¨æ€è€ƒå¹¶å›ç­”ï¼šè¿™äº›ç ”ç©¶å‘ç°ä¸æ‚¨åœ¨ç›´è§’ä¸‰è§’å½¢æ•™å­¦ä¸­çš„å®é™…ä½“éªŒæ˜¯å¦ä¸€è‡´ï¼Ÿæ‚¨åœ¨æ•°å­¦æ¦‚å¿µæ•™å­¦ä¸­æœ‰å“ªäº›æˆåŠŸçš„æé—®ç»éªŒå¯ä»¥åˆ†äº«ï¼Ÿæ‚¨è®¤ä¸ºæ•°å­¦è¯¾çš„æé—®åº”è¯¥å…·å¤‡ä»€ä¹ˆç‰¹æ®Šæ€§ï¼Ÿ",
      
      "è®©æˆ‘ä»¬ç»“åˆæ–‡çŒ®åˆ¶å®šå…·ä½“ç­–ç•¥ã€‚åŸºäºç ”ç©¶è¯æ®ï¼Œæˆ‘æœ‰å‡ ä¸ªé’ˆå¯¹æ•°å­¦è¯¾å ‚çš„æ”¹è¿›å»ºè®®ã€‚ä½†æˆ‘æƒ³å…ˆå¬å¬æ‚¨çš„æƒ³æ³•ï¼šåœ¨å‡ ä½•æ¦‚å¿µæ•™å­¦ä¸­ï¼Œæ‚¨è§‰å¾—æœ€å¤§çš„æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿæ‚¨å¸Œæœ›é€šè¿‡æé—®è¾¾åˆ°ä»€ä¹ˆæ•ˆæœï¼Ÿè¯·æå‡ºä¸€ä¸ªæ‚¨å…³å¿ƒçš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸€èµ·æ¢è®¨è§£å†³æ–¹æ¡ˆã€‚",
      
      "ç°åœ¨æˆ‘ä»¬æ¥åˆ¶å®šæ‚¨ä¸“å±çš„æ•°å­¦è¯¾å ‚æé—®æ”¹è¿›è®¡åˆ’ã€‚è¯·æ‚¨ä¸»åŠ¨åˆ†äº«ï¼šåŸºäºæˆ‘ä»¬çš„è®¨è®ºå’Œæ–‡çŒ®è¯æ®ï¼Œæ‚¨æœ€æƒ³åœ¨ä¸‹æ¬¡æ•°å­¦è¯¾ä¸­å°è¯•ä»€ä¹ˆæ–°çš„æé—®ç­–ç•¥ï¼Ÿæ‚¨è§‰å¾—å®æ–½è¿™ä¸ªç­–ç•¥å¯èƒ½é‡åˆ°ä»€ä¹ˆå›°éš¾ï¼Ÿæ‚¨å¸Œæœ›æˆ‘ä»å“ªä¸ªè§’åº¦ç»™æ‚¨æ›´å¤šæ”¯æŒï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·è®¾è®¡ä¸€ä¸ªå…·ä½“çš„å®æ–½æ–¹æ¡ˆã€‚"
    ],

    completionAnalysis: `è¯·åŸºäºæ–‡çŒ®ä¼˜åŒ–å¯¹è¯ï¼Œç”Ÿæˆæœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼š

æ•´åˆè¦ç‚¹ï¼š
1. é‡‡çº³çš„ç ”ç©¶è¯æ®å’Œç†è®ºæ”¯æ’‘
2. ç»“åˆæ•™å¸ˆæƒ…å¢ƒçš„å…·ä½“ç­–ç•¥
3. è¯¦ç»†çš„å®æ–½æ­¥éª¤å’Œè®¡åˆ’
4. é¢„æœŸæ•ˆæœå’Œè¯„ä¼°æ–¹å¼

è¿”å›JSONæ ¼å¼ï¼š
{
  "theoreticalBasis": "ç†è®ºä¾æ®",
  "strategies": ["ç­–ç•¥1", "ç­–ç•¥2", "ç­–ç•¥3"],
  "implementationPlan": "å®æ–½è®¡åˆ’",
  "expectedOutcomes": "é¢„æœŸæ•ˆæœ",
  "evaluationMethod": "è¯„ä¼°æ–¹æ³•"
}`
  }
};

// æ­¥éª¤é…ç½®ä¿¡æ¯
export const RESEARCH_STEPS_INFO = [
  {
    id: 1,
    name: 'å®šä½',
    fullName: 'å®šä½æ•™ç ”ç›®æ ‡',
    description: 'é€šè¿‡3è½®å¯¹è¯å¿«é€Ÿè¯†åˆ«äº”ç±»çŸ¥è¯†ç¼ºå¤±',
    icon: 'ğŸ¯',
    color: '#CF1421'
  },
  {
    id: 2, 
    name: 'è§£è¯»',
    fullName: 'è§£è¯»è¯¾å ‚ç°è±¡',
    description: 'ç»“åˆå¯è§†åŒ–æ•°æ®åˆ†æè¯¾å ‚æé—®é—®é¢˜',
    icon: 'ğŸ“Š',
    color: '#3AA343'  
  },
  {
    id: 3,
    name: 'æ¢ç©¶',
    fullName: 'æ¢ç©¶è¯¾ä¾‹è¯æ®',
    description: 'åŸºäºç ”ç©¶æ–‡çŒ®è¯æ®ä¼˜åŒ–è§£å†³æ–¹æ¡ˆ',
    icon: 'ğŸ“š',
    color: '#3F7AAB'
  },
  {
    id: 4,
    name: 'èƒå–',
    fullName: 'èƒå–å®è·µçŸ¥è¯†',
    description: 'é€‰æ‹©å­¦ä¹ å¡ç‰‡å¯¼å‡ºä¸ªæ€§åŒ–æ•™ç ”æˆæœ',
    icon: 'ğŸ’',
    color: '#FCB700'
  }
];

// è·å–ç‰¹å®šæ­¥éª¤çš„é…ç½®
export const getStepConfig = (step: number): ResearchStepConfig => {
  return QUESTIONING_RESEARCH_PROMPTS[`step${step}`] || QUESTIONING_RESEARCH_PROMPTS.step1;
};

// è·å–æ­¥éª¤ä¿¡æ¯
export const getStepInfo = (step: number) => {
  return RESEARCH_STEPS_INFO.find(s => s.id === step) || RESEARCH_STEPS_INFO[0];
};

// ç”ŸæˆåŠ¨æ€æç¤ºè¯
export const generateStepPrompt = (
  step: number, 
  round: number, 
  context: any = {}
): string => {
  const config = getStepConfig(step);
  
  // è·å–è¯¾ç¨‹èƒŒæ™¯ä¿¡æ¯
  let lessonContext = '';
  try {
    lessonContext = generateLessonContextPrompt();
  } catch (error) {
    console.error('è·å–è¯¾ç¨‹èƒŒæ™¯ä¿¡æ¯å¤±è´¥:', error);
    lessonContext = `
**ã€è¯¾ç¨‹èƒŒæ™¯ä¿¡æ¯ã€‘**
- å­¦ç§‘ï¼šæ•°å­¦
- ä¸»é¢˜ï¼šç›´è§’ä¸‰è§’å½¢çš„æ€§è´¨
- å¹´çº§ï¼šå°å­¦é«˜å¹´çº§
- æ—¶é•¿ï¼š47åˆ†é’Ÿ

**ã€é‡è¦æé†’ã€‘**
åœ¨åˆ†æè¯¾å ‚æé—®æ—¶ï¼Œå¿…é¡»ç»“åˆä»¥ä¸Šè¯¾ç¨‹èƒŒæ™¯ï¼Œç¡®ä¿æ‰€æœ‰åˆ†æã€å»ºè®®ã€æ¡ˆä¾‹éƒ½ä¸ã€æ•°å­¦å­¦ç§‘çš„ç›´è§’ä¸‰è§’å½¢çš„æ€§è´¨ã€‘ä¸»é¢˜ç›¸å…³ã€‚`;
  }
  
  let prompt = config.systemPrompt
    .replace(/\{\{currentRound\}\}/g, String(round))
    .replace(/\{\{identifiedWeakness\}\}/g, context.identifiedWeakness || '')
    .replace(/\{\{focusAreas\}\}/g, context.focusAreas?.join('ã€') || '')
    .replace(/\{\{keyInsights\}\}/g, context.keyInsights?.join('ã€') || '')
    .replace(/\{\{improvementDirection\}\}/g, context.improvementDirection || '');

  // æ³¨å…¥æ•°æ®åˆ†æç»“æœï¼ˆæ­¥éª¤2ï¼‰
  if (step === 2 && context.dataVisualizationResults) {
    prompt = prompt.replace(
      /\{\{dataVisualizationResults\}\}/g, 
      JSON.stringify(context.dataVisualizationResults, null, 2)
    );
  }

  // æ³¨å…¥æ–‡çŒ®è¯æ®ï¼ˆæ­¥éª¤3ï¼‰
  if (step === 3 && context.literatureEvidence) {
    prompt = prompt.replace(
      /\{\{literatureEvidence\}\}/g,
      context.literatureEvidence.join('\n\n')
    );
  }

  // æ·»åŠ è¯¾ç¨‹èƒŒæ™¯ä¿¡æ¯åˆ°ç³»ç»Ÿæç¤ºè¯
  prompt = lessonContext + '\n\n' + prompt;

  // æ·»åŠ å½“å‰è½®æ¬¡çš„å…·ä½“é—®é¢˜
  const roundQuestion = config.rounds[round - 1]
    .replace(/\{\{identifiedWeakness\}\}/g, context.identifiedWeakness || 'ä¸»è¦é—®é¢˜');

  return `${prompt}\n\nå½“å‰è½®æ¬¡é—®é¢˜ï¼š\n${roundQuestion}`;
};

// è½®æ¬¡æè¿°
export const getRoundDescription = (step: number, round: number): string => {
  const descriptions = {
    1: ['äº†è§£å›°æƒ‘èƒŒæ™¯', 'æ¢ç´¢å®è·µè¿‡ç¨‹', 'ç†è®ºè®¤çŸ¥è°ƒç ”'],
    2: ['è§‚å¯Ÿæ•°æ®ç°è±¡', 'åˆ†æé—®é¢˜å…³è”', 'ç¡®å®šæ”¹è¿›æ–¹å‘'], 
    3: ['ç ”ç©¶è¯æ®å¯å‘', 'ç­–ç•¥æƒ…å¢ƒé€‚é…', 'åˆ¶å®šå®æ–½è®¡åˆ’']
  };
  
  return descriptions[step as keyof typeof descriptions]?.[round - 1] || 'æ·±å…¥åˆ†æ';
};